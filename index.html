<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>财务管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --success-color: #50c51a;
            --danger-color: #ff4d4f;
        }
        .stat-card { 
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .upload-preview {
            max-width: 120px;
            border: 2px dashed #ddd;
            padding: 8px;
        }
        .preview-btn {
    --btn-color: #4a90e2; /* 与主色一致 */
    padding: 4px 12px;
    border: 1px solid var(--btn-color);
    color: var(--btn-color);
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.preview-btn:hover {
    background: rgba(74, 144, 226, 0.1);
    transform: translateY(-1px);
}

.preview-icon {
    fill: currentColor;
}

/* 预览弹窗样式 */
.preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
}

.preview-modal.active {
    display: flex;
}

.preview-content {
    max-width: 90%;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 16px;
}
    </style>
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: var(--primary-color)">
        <div class="container">
            <a class="navbar-brand" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cash-stack" viewBox="0 0 16 16">
                    <path d="M14 3H1a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1h-1z"/>
                    <path fill-rule="evenodd" d="M15 5H1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5zM4 11a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
                </svg>
                财务管理系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="#" onclick="showView('dashboard')">仪表盘</a>
                    <a class="nav-link" href="#" onclick="showView('records')">流水记录</a>
                    <a class="nav-link" href="#" onclick="showView('new')">新增记录</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 仪表盘 -->
    <div id="dashboard" class="container mt-4 view">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="stat-card card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">总收入</h5>
                        <h2 id="totalIncome">0.00</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card card text-white bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">总支出</h5>
                        <h2 id="totalExpense">0.00</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">当前结余</h5>
                        <h2 id="totalBalance">0.00</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增记录 -->
    <div id="new" class="container mt-4 view" style="display: none;">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="card-title mb-4">新增财务记录</h4>
                <form id="recordForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">日期</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">分类</label>
                        <select class="form-select" id="category" required>
                            <option value="">请选择分类</option>
                            <optgroup label="收入">
                                <option value="工资">工资</option>
                                <option value="投资">投资</option>
                            </optgroup>
                            <optgroup label="支出">
                                <option value="餐饮">餐饮</option>
                                <option value="房租">房租</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">收入金额</label>
                        <div class="input-group">
                            <span class="input-group-text">￥</span>
                            <input type="number" class="form-control" id="income" step="0.01">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">支出金额</label>
                        <div class="input-group">
                            <span class="input-group-text">￥</span>
                            <input type="number" class="form-control" id="expense" step="0.01">
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">上传凭证</label>
                        <div class="border rounded p-3">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="imageUpload" accept="image/*">
                            </div>
                            <div id="imagePreview" class="upload-preview"></div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="note" rows="2"></textarea>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                            </svg>
                            保存记录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 流水记录 -->
    <div id="records" class="container mt-4 view" style="display: none;">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="card-title mb-4">财务流水</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>分类</th>
                                <th>收入</th>
                                <th>支出</th>
                                <th>凭证</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'api.php';
        let authToken = 'Bearer your_secret_key'; // 与后端一致

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showView('dashboard');
            loadStatistics();
            document.getElementById('recordForm').addEventListener('submit', handleSubmit);
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        });

        // 视图切换
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'block';
            
            if(viewId === 'dashboard') loadStatistics();
            if(viewId === 'records') loadRecords();
        }

        // 提交表单
        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                income: parseFloat(document.getElementById('income').value) || 0,
                expense: parseFloat(document.getElementById('expense').value) || 0,
                image: document.getElementById('imagePreview').querySelector('img')?.src || '',
                note: document.getElementById('note').value
            };

            if (!formData.date || !formData.category) {
                alert('日期和分类为必填项');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}?action=create_record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '保存失败');
                }

                alert('记录保存成功！');
                e.target.reset();
                document.getElementById('imagePreview').innerHTML = '';
                showView('dashboard');
            } catch (error) {
                alert(error.message);
            }
        }

        // 图片上传
        async function handleImageUpload() {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`${API_BASE}?action=upload_image`, {
                    method: 'POST',
                    headers: {
                        'Authorization': authToken
                    },
                    body: formData
                });

                const { url } = await response.json();
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${url}" class="img-fluid rounded" 
                         onclick="window.open('${url}', '_blank')">
                `;
            } catch (error) {
                alert('图片上传失败: ' + error.message);
            }
        }

        // 加载统计
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}?action=get_stats`);
                const data = await response.json();
                
                document.getElementById('totalIncome').textContent = data.total_income.toFixed(2);
                document.getElementById('totalExpense').textContent = data.total_expense.toFixed(2);
                document.getElementById('totalBalance').textContent = data.balance.toFixed(2);
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

      // 修改后的 loadRecords 函数
async function loadRecords() {
    try {
        const response = await fetch(`${API_BASE}?action=get_records`);
        const records = await response.json();
        
        const tbody = document.getElementById('recordsBody');
        tbody.innerHTML = records.map(record => `
            <tr>
                <td>${record.date}</td>
                <td>${record.category}</td>
                <td class="text-success">${record.income > 0 ? '￥' + parseFloat(record.income).toFixed(2) : '-'}</td>
                <td class="text-danger">${record.expense > 0 ? '￥' + parseFloat(record.expense).toFixed(2) : '-'}</td>
<td>${record.image ? 
    `<button class="btn btn-sm btn-outline-primary preview-btn" 
            data-image="${record.image}"
            onclick="showPreview('${record.image}')">
        <svg class="preview-icon" viewBox="0 0 24 24" width="16" height="16">
            <path d="M12 4.5C7 4.5 2.7 7.6 1 12c1.7 4.4 6 7.5 11 7.5s9.3-3.1 11-7.5c-1.7-4.4-6-7.5-11-7.5zM12 17c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5zm0-8c-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3-1.3-3-3-3z"/>
        </svg>
        查看凭证
    </button>` 
    : '无'}
</td>
<!-- 添加备注列 -->
            <td>${record.note || '--'}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('加载记录失败:', error);
    }
}
function showPreview(imgUrl) {
    const modal = document.createElement('div');
    modal.className = 'preview-modal active';
    modal.innerHTML = `
        <div class="preview-content">
            <img src="${imgUrl}" class="img-fluid" style="max-height:80vh">
            <div class="text-center mt-3">
                <button onclick="this.closest('.preview-modal').remove()" 
                        class="btn btn-danger btn-sm">
                    关闭
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// 点击外部关闭
document.addEventListener('click', (e) => {
    if(e.target.classList.contains('preview-modal')) {
        e.target.remove();
    }
});
    </script>
</body>
</html>